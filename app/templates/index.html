<!DOCTYPE html>
<html>
<head>
	<title>AgriDigital Sprint Dashboard</title>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/style.css') }}">
<!-- 
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
 -->
	<script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
	<script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
	<script src="{{ url_for('static', filename='js/jquery-ui.js') }}"></script>
	<script src="{{ url_for('static', filename='js/loader.js') }}"></script>

</head>
<body>

	<div class="jumbotron">
		<h1>AgriDigital Sprint Dashboard</h1>
		<h3>{{ stories[0]['sprints'][0]['name'] }} | {{ stories[0]['sprints'][0]['state'] }}</h3>
		<div id="sprint_input_group" class="input-group">
			<div class="input-group-prepend">
				<span class="input-group-text">Sprint No:</span>
			</div>
			<input id="sprint_input" type="text" class="form-control" value="">
		</div>		
	</div>

	
	<!--   DASHBOARD    -->

	<div class="container-fluid">

		<!--   TABLE    -->

		<div class="row">
			<div class="col-lg-6" align="left">
				<h3>Sprint Stories</h3>
			</div>
			<div class="col-lg-6" align="right">
				<button id="table_expand_all" type="button" class="btn btn-success btn-expand_all">Expand All</button>
			</div>
		</div>
		
		<br>

		<div class="row">
			<table class="table table-condensed">
				<thead>
					<tr>
						<th>Issue Key</th>
						<th>Issue Type      </th>
						<th class="cell_summary">Summary</th>
						<th>Subtask   </th>
						<th>Status               </th>
						<th>Assignee      </th>
						<th>Original Estimate</th>
						<th>Time Spent</th>
						<th>Remaining Time</th>
						<th>Progress</th>
						<th></th>
						<th>To Do </th>
						<th>In Dev</th>
						<th>DevRev</th>
						<th>Aw UAT</th>
						<th>Done  </th>
					</tr>
				</thead>
				<tbody>
					{% for issue in stories %}
						<tr class="row_story">

							<td><a href="{{ issue.self }}">{{ issue.key }}</a></td>
							<td><img src="{{ issue.issuetypeIcon }}" height="15" width="15"> {{ issue.issuetype }}</td>
							<td class="cell_summary">{{ issue.summary }}</td>
							<td style="text-align: center;">{{ issue.subtasks|length }}</td>
							<td>{{ issue.status }}</td>
							<td>{{ issue.assignee }}</td>
							<td class="cell_time">{% if issue.aggregatetimeoriginalestimate != None %}{{ issue.aggregatetimeoriginalestimate_str }}{% endif %}</td>
							<td class="cell_time">{% if issue.aggregatetimespent != None %}{{ issue.aggregatetimespent_str }}{% endif %}</td>
							<td class="cell_time">{% if issue.aggregatetimeestimate != None %}{{ issue.aggregatetimeestimate_str }}{% endif %}</td>
							<td class="cell_progress_percentage">{% if issue.progress != None %}{{ issue.progress }}%{% endif %}</td>
							<td class="cell_progress"><div class="progress" style="height: 10px; width: 100%"><div class="progress-bar" style="height: 10px; width: {{ issue.progress }}%"></div></div></td>						
							<td class="cell_status_count">{% if issue.subtask_status_count['To Do'] > 0 %}{{ issue.subtask_status_count['To Do'] }}{% endif %}</td>
							<td class="cell_status_count">{% if issue.subtask_status_count['Dev In Progress'] > 0 %}{{ issue.subtask_status_count['Dev In Progress'] }}{% endif %}</td>
							<td class="cell_status_count">{% if issue.subtask_status_count['Dev Review'] > 0 %}{{ issue.subtask_status_count['Dev Review'] }}{% endif %}</td>
							<td class="cell_status_count">{% if issue.subtask_status_count['Awaiting UAT'] > 0 %}{{ issue.subtask_status_count['Awaiting UAT'] }}{% endif %}</td>
							<td class="cell_status_count">{% if issue.subtask_status_count['Done'] > 0 %}{{ issue.subtask_status_count['Done'] }}{% endif %}</td>

							{% if issue.subtasks|length > 0 %}

								{% for subtask in issue.subtasks %}

									<tr class="row_subtask">
										
										<td><a href="{{ subtask.self }}">{{ subtask.key }}</td></a>
										<td><img src="{{ subtask.issuetypeIcon }}" height="15" width="15"> {{ subtask.issuetype }}</td>
										<td class="cell_summary">{{ subtask.summary }}</td>
										<td>{{ subtask.devteam }}</td>
										<td>{{ subtask.status }}</td>
										<td>{{ subtask.assignee }}</td>
										<td class="cell_time">{% if subtask.aggregatetimeoriginalestimate != None %}{{ subtask.aggregatetimeoriginalestimate_str }}{% endif %}</td>
										<td class="cell_time">{% if subtask.aggregatetimespent != None %}{{ subtask.aggregatetimespent_str }}{% endif %}</td>
										<td class="cell_time">{% if subtask.aggregatetimeestimate != None %}{{ subtask.aggregatetimeestimate_str }}{% endif %}</td>
										<td class="cell_progress_percentage">{% if subtask.progress != None %}{{ subtask.progress }}%{% endif %}</td>
										<td class="cell_progress"><div class="progress" style="height: 10px; width: 100%"><div class="progress-bar bg-warning" style="height: 10px; width: {{ subtask.progress }}%"></div></div></td>
										<td class="cell_status_count">{% if subtask.status == 'To Do' %}*{% endif %}</td>
										<td class="cell_status_count">{% if subtask.status == 'Dev In Progress' %}*{% endif %}</td>
										<td class="cell_status_count">{% if subtask.status == 'Dev Review' %}*{% endif %}</td>
										<td class="cell_status_count">{% if subtask.status == 'Awaiting UAT' %}*{% endif %}</td>
										<td class="cell_status_count">{% if subtask.status == 'Done' %}*{% endif %}</td>
									</tr>

								{% endfor %}

							{% endif %}

						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>

		<!--   BURNDOWNS    -->
		<br>

		<div class="row">
			<h3>Sprint Burndown</h3>
		</div>

		<br>

		<div class="row">
			<div class="col-lg-6">
				<div id="backend_burndown_chart" class="chart_div"></div>
			</div>
			<div class="col-lg-6">
				<div id="frontend_burndown_chart" class="chart_div"></div>
			</div>
		</div>

	</div>




</body>

<script type="text/javascript">

	
	$('.row_story').click(function(){
		$(this).nextUntil('tr.row_story').slideToggle(200);
	});

	$('#sprint_input').keypress(function(e){
		if(e.which == 13){
			console.log("Sprint_input entered:", $(this).val());
			window.location.replace(window.location.origin + "/sprint/" + $(this).val())
		}
	});

	$('div.row').on('click', 'button.btn-expand_all', function(event) {
		$('tr.row_subtask').attr("style", "display: table-row;");
		$(this).removeClass("btn-success");
		$(this).addClass("btn-warning");
		$(this).removeClass("btn-expand_all");
		$(this).addClass("btn-collapse_all");
		$(this).text("Collapse All");
	})
	
	$('div.row').on('click', 'button.btn-collapse_all', function(event){
		$('tr.row_subtask').attr("style", "display: none;");
		$(this).addClass("btn-success");
		$(this).removeClass("btn-warning");
		$(this).addClass("btn-expand_all");
		$(this).removeClass("btn-collapse_all");
		$(this).text("Expand All");
	})

	// $(document).ready(function(){
	// 	$('#sprint_input').attr('value', window.location.pathname.slice(8,10));
	// 	$.get('/sprint/76/data').done(function(data){
	// 		console.log(data)
	// 	});
	// })

    var ticks_list = [];
	var millieconds_per_day = 1000*60*60*24;
	var start_date = new Date('{{ stories[0]['sprints'][0]['startDate'] }}');
	start_date.setMilliseconds(0);
	start_date.setSeconds(0);
	start_date.setMinutes(0);
	start_date.setHours(0);

	for(i = 1; i < 14; i++){
		ticks_list.push({v: new Date(Date.parse(start_date) + i * millieconds_per_day)})
	};

	google.charts.load('current', {'packages':['line']});
    google.charts.setOnLoadCallback(drawBackendBurndown);
    google.charts.setOnLoadCallback(drawFrontendBurndown);

    function drawBackendBurndown() {

      var data = new google.visualization.DataTable(
      	{
      		cols: [{id: 'datetime', label: 'Time', type: 'date'},
	      	       {id: 'timeestimate', label: 'Time Estimate', type:'number'}
	      	       ],
	      	rows: [{% for d in  backend_burndown %}{c: [{v: new Date('{{ d[0] }}')}, {v: {{ d[1] /(60 * 60) }}}]},
	      	{% endfor %}]
      	});

      // data.addRows();

      var options = {
      	title: 'Backend subtasks',
      	vAxis: {title: 'Time Estimate [Hours]'},
      	hAxis: {
      		// viewWindow: {
      		// 	min: new Date('{{ stories[0]['sprints'][0]['startDate'] }}'),
      		// 	max: new Date('{{ stories[0]['sprints'][0]['endDate'] }}'),
      		// }
      	},
      	legend: {position: 'none'},
      	height: 400,
      	width: 700,
      };

      var chart = new google.charts.Line(document.getElementById('backend_burndown_chart'));

      chart.draw(data, google.charts.Line.convertOptions(options));
    }

    function drawFrontendBurndown() {

      var data = new google.visualization.DataTable(
      	{
      		cols: [{id: 'datetime', label: 'Time', type: 'date'},
	      	       {id: 'timeestimate', label: 'Time Estimate', type: 'number'},
	      	       {role: 'tooltip', label:'Key', type: 'string'},
	      	       ],
	      	rows: [{% for d in  frontend_burndown %}{c: [{v: new Date('{{ d[0] }}')}, {v: {{ d[1] /(60 * 60) }}}, {v: '{{ d[2] }}'}]},
	      		{% endfor %}]
      	});

      // data.addRows();

      var options = {
      	title: 'Front End subtasks',
      	vAxis: {title: 'Time Estimate [Hours]'},
      	hAxis: {
      		viewWindow: {
      			min: start_date,
      			max: new Date(Date.parse(start_date) + 14 * millieconds_per_day),
      		},
            ticks: ticks_list,
        },
      	legend: {position: 'none'},
      	series: {0: { color: '#e2431e'}},
      	height: 400,
      	width: 700,
      };

      var chart = new google.charts.Line(document.getElementById('frontend_burndown_chart'));

      chart.draw(data, google.charts.Line.convertOptions(options));
    }

	

</script>


</html>